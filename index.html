<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>PALLAS Sprachdemo</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; text-align:center; }
    h1 { color:#2a5d84; }
    button { padding:12px 20px; margin:8px; border:none; border-radius:8px; background:#2a5d84; color:white; font-size:16px; cursor:pointer; }
    button:hover { background:#1c3f5c; }
    #player { margin-top:20px; width:80%; }
    #micStatus { margin-top:12px; font-weight:bold; }
  </style>

  <!-- Manifest + Service Worker -->
  <link rel="manifest" href="manifest.json">
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("Service Worker registriert"))
        .catch(err => console.error("SW Fehler:", err));
    }
  </script>
</head>
<body>
  <h1>üéôÔ∏è PALLAS Sprachdemo</h1>
  <p>Sage die Befehle oder nutze den Button. Mikro pausiert automatisch w√§hrend Audio.</p>

  <button id="micToggle">üé§ Mikro an</button>
  <p id="micStatus">Inaktiv</p>

  <div id="buttons"></div>
  <audio id="player" controls></audio>

  <script>
    // Schritte mit Stichwort-Erkennung
    const steps = [
      { label:"Hey PALLAS", phrases:["hey","pallas","hallo"], audios:["1.mp3","2.mp3"] },
      { label:"Noradrenalin Perfusor", phrases:["noradrenalin","perfusor"], audios:["3.mp3"] },
      { label:"50 ml mit 20 ¬µg/ml", phrases:["50","20 mikrogramm"], audios:["4.mp3"] },
      { label:"Ja", phrases:["ja","genau","richtig"], audios:["5.mp3"] },
      { label:"Weiter", phrases:["weiter","ok"], audios:["6.mp3"] },
      { label:"Weiter", phrases:["weiter"], audios:["7.mp3"] },
      { label:"Weiter", phrases:["weiter"], audios:["8.mp3"] },
      { label:"Weiter", phrases:["weiter"], audios:["9.mp3"] },
      { label:"Weiter", phrases:["weiter"], audios:["10.mp3"] },
      { label:"Weiter", phrases:["weiter"], audios:["11.mp3"] },
      { label:"Nein, danke", phrases:["nein","danke"], audios:["12.mp3"] }
    ];

    let idx = 0;
    let queue = [];
    let recognition = null;
    let listening = false;  // Nutzer hat Mikro aktiviert
    let swLocked = false;   // w√§hrend Audio blockieren

    const player = document.getElementById("player");
    const buttonsDiv = document.getElementById("buttons");
    const micBtn = document.getElementById("micToggle");
    const micStatus = document.getElementById("micStatus");

    const normalize = s => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();

    function renderButton() {
      buttonsDiv.innerHTML = "";
      if (idx < steps.length) {
        const step = steps[idx];
        const btn = document.createElement("button");
        btn.textContent = "Sag: " + step.label;
        btn.onclick = () => playStep(step);
        buttonsDiv.appendChild(btn);
      } else {
        buttonsDiv.innerHTML = "<p><b>Interaktion beendet ‚úÖ</b></p>";
      }
    }

    function playStep(step) {
      queue = [...step.audios];
      swLocked = true;
      stopListeningSilently();  // Mikro pausieren
      playNext(() => {
        swLocked = false;
        setTimeout(() => { if (listening) startListening(); }, 200); // Mikro wieder aktivieren
        idx++;
        renderButton();
      });
    }

    function playNext(done) {
      if (queue.length === 0) { done && done(); return; }
      const nextFile = queue.shift();
      player.src = nextFile;
      player.onended = () => playNext(done);
      player.onerror = () => playNext(done);
      player.play().catch(() => playNext(done));
    }

    function startListening() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { micStatus.textContent = "Nicht unterst√ºtzt (Chrome/Edge nutzen)"; return; }
      if (!recognition) {
        recognition = new SR();
        recognition.lang = "de-DE";
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.onresult = (e) => {
          if (swLocked) return; // w√§hrend Audio keine Kommandos
          for (let i = e.resultIndex; i < e.results.length; i++) {
            if (!e.results[i].isFinal) continue;
            const text = normalize(e.results[i][0].transcript);
            handleCommand(text);
          }
        };
        recognition.onend = () => {
          if (listening && !swLocked) {
            try { recognition.start(); } catch {}
          }
        };
      }
      try { recognition.start(); } catch {}
      listening = true;
      micStatus.textContent = "Aktiv ‚Äì h√∂rt zu";
      micBtn.textContent = "üé§ Mikro aus";
    }

    function stopListeningSilently() {
      try { recognition && recognition.stop(); } catch {}
    }
    function stopListening() {
      listening = false;
      stopListeningSilently();
      micStatus.textContent = "Inaktiv";
      micBtn.textContent = "üé§ Mikro an";
    }

    micBtn.addEventListener("click", () => {
      listening ? stopListening() : startListening();
    });

    function handleCommand(text) {
      if (idx >= steps.length) return;
      const step = steps[idx];
      for (const phrase of step.phrases) {
        if (text.includes(phrase)) { playStep(step); break; }
      }
    }

    // Sicherheit: Mikro aus, wenn Audio l√§uft
    player.addEventListener('play',  () => { swLocked = true; stopListeningSilently(); });
    player.addEventListener('ended', () => { swLocked = false; if (listening) setTimeout(() => startListening(), 200); });

    renderButton();
  </script>
</body>
</html>
