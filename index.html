<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>PALLAS Sprachdemo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --pallas:#2a5d84; --bg:#eef3f8; --bubble-user:#daf0ff; --bubble-pallas:#ffffff; --ok:#2ecc71; --err:#e74c3c; }
    body { margin:0; font-family:'Segoe UI', Roboto, Arial, sans-serif; background:var(--bg); display:flex; flex-direction:column; height:100vh; }
    header { background:var(--pallas); color:#fff; padding:14px 20px; display:flex; align-items:center; gap:12px; box-shadow:0 2px 6px rgba(0,0,0,.15); }
    header h1 { margin:0; font-size:20px; font-weight:700; }
    #logo { width:48px; height:48px; border-radius:50%; background:var(--pallas); display:grid; place-items:center; color:#fff; position:relative; }
    #logo.listening::after { content:""; position:absolute; inset:0; border-radius:50%; border:2px solid rgba(42,93,132,.4); animation:pulse 1.6s infinite; }
    @keyframes pulse { 0%{transform:scale(1); opacity:.6;} 70%{transform:scale(1.4); opacity:0;} 100%{opacity:0;} }
    .progress { height:6px; background:#cbd5e1; width:100%; }
    .bar { height:100%; background:linear-gradient(90deg,#2a5d84,#3b7aa9); width:0%; transition:width .4s ease; }
    main { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:12px; }
    .msg { max-width:70%; padding:12px 16px; border-radius:18px; font-size:16px; line-height:1.4; animation:fadeIn .3s ease; word-break:break-word; }
    .msg.user { background:var(--bubble-user); align-self:flex-end; border-bottom-right-radius:4px; }
    .msg.pallas { background:var(--bubble-pallas); align-self:flex-start; border-bottom-left-radius:4px; box-shadow:0 2px 4px rgba(0,0,0,.08); }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:none;} }
    footer { padding:12px; background:#fff; display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center; border-top:1px solid #e2e8f0; position:sticky; bottom:0; }
    footer .left, footer .right { display:flex; gap:12px; align-items:center; }
    .iconbtn { display:inline-grid; place-items:center; width:44px; height:44px; border:none; border-radius:10px; background:var(--pallas); color:#fff; font-size:20px; cursor:pointer; }
    .iconbtn:hover { filter:brightness(.95); }
    .dot { width:12px; height:12px; border-radius:50%; box-shadow:0 0 0 2px #ffffff; }
    .dot.green { background:var(--ok); }
    .dot.red   { background:var(--err); }
    .toggle { display:flex; align-items:center; gap:8px; font-size:14px; color:#173249; }
    .switch { position:relative; width:44px; height:24px; background:#cbd5e1; border-radius:999px; cursor:pointer; }
    .switch::after { content:""; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background:#fff; transition:left .2s ease; }
    .switch.on { background:#2a5d84; }
    .switch.on::after { left:23px; }
    .textinput { flex:1; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:15px; }
  </style>

  <!-- (optional) PWA -->
  <link rel="manifest" href="manifest.json" />
  <script>
    if ("serviceWorker" in navigator) { navigator.serviceWorker.register("service-worker.js").catch(()=>{}); }
  </script>
</head>
<body>
  <header>
    <div id="logo">üé§</div>
    <h1>PALLAS ‚Äì Pflegeassistenz</h1>
  </header>

  <div class="progress"><div id="bar" class="bar"></div></div>

  <main id="chat"></main>

  <!-- Footer wird dynamisch je nach Support aufgebaut -->
  <footer id="controls"></footer>

  <!-- Audio -->
  <audio id="player" preload="auto" controls style="display:none"></audio>
  <audio id="ready"  preload="auto" src="1.mp3"></audio>
  <audio id="repeat" preload="auto" src="nochmal.mp3"></audio>

  <script>
    /* ======= Daten & State ======= */
    const steps = [
      { phrases:["hey","pallas","hallo"], audios:["1.mp3","2.mp3"], text:"Hallo, was kann ich f√ºr dich tun?" },
      { phrases:["noradrenalin","nor adrenalin","nur adrenalin","nora","noradrenaline","nora adrenalin","perfusor"], audios:["3.mp3"], text:"Alles klar, einen Noradrenalin Perfusor also. Welche Dosierung m√∂chtest du vorbereiten?" },
      { phrases:["50","20 mikrogramm"], audios:["4.mp3"], text:"In Ordnung. Du m√∂chtest also eine 50ml Noradrenalinperfursor Spritze mit einer Dosierung von 20 Mikrogramm pro Milliliter vorbereiten, habe ich das richtig verstanden?" },
      { phrases:["ja","genau","richtig"], audios:["5.mp3"], text:"Ok du ben√∂tigst daf√ºr folgende Materialien: Ein Medikamententablett, Alkoholisches Desinfektionsmittel, Aufziehkan√ºle, Perfusorspritze, Brechampulle Noradrenalin 1mg auf 1 Milliliter, 50 ml NaCl, Perfusioleitung, Einmalhandschuhe und Abwurfbeh√§lter. Wenn dir das zu schnell ging, sag einfach ‚ÄûNochmal‚Äú, wenn du so weit bist sag einfach ‚ÄûWeiter‚Äú." },
      { phrases:["weiter"], audios:["6.mp3"], text:"Nachdem du dir die Einmal-Handschuhe angezogen hast, bereitest du nun die Perfusor Spritze vor. √ñffne die Spritze an der daf√ºr vorgesehenen Lasche. Beachte, dass der Konus der Spritze weiterhin in der sterilen Verpackung bleibt. Nimm dir nun das vorbereitete NaCl und desinfiziere die Einstichstelle mit der Desinfektionsl√∂sung. Achte auf die vorgeschriebene Einwirkzeit. Wenn du so weit bist, sag einfach ‚Äûweiter‚Äú." },
      { phrases:["weiter"], audios:["7.mp3"], text:"Ziehe dir nun 49ml NaCl mit der Perfusorspritze und der dazugeh√∂rigen Aufziehkan√ºle auf. Verwurfe danach die Aufziehkan√ºle im Abwurfbeh√§lter. Achte besonders darauf, den Konus der Perfusorspritze nicht zu verunreinigen. √ñffne nun die Verpackung der anderen Aufziehkan√ºle und verbinde diese mit der Perfusorspritze. Wenn du so weit bist, sag einfach ‚Äûweiter‚Äú." },
      { phrases:["weiter"], audios:["8.mp3"], text:"Belasse die Perfusorspritze mit der konnektierten Aufziehkan√ºle in der Verpackung. Nimm jetzt die Noradrenalin-Brechampulle, pr√ºfe noch einmal, ob es sich um das richtige Medikament und die richtige Dosierung handelt. Halte die Sollbruchstelle zu dir hin und brich die Ampulle auf. Achte sorgf√§ltig darauf, die ge√∂ffnete Ampulle nicht zu verunreinigen. Ziehe nun das Medikament mit der Perfusorspritze auf." },
      { phrases:["weiter"], audios:["9.mp3"], text:"Verwirf die Aufziehkan√ºle in den Abwurfbeh√§lter. √ñffne die Verpackung der Perfusor-Leitung, nimm den Abgang der Leitung und verbinde ihn mit der Perfusorspritze. Bef√ºlle die gesamte Leitung mit der Medikamentenl√∂sung, bis sich keine Luft mehr in Spritze und Leitungssystem befindet. Die patientennahe Kappe bleibt vorerst an der Leitung. Wenn du fertig bist, sag ‚Äûweiter‚Äú." },
      { phrases:["weiter"], audios:["10.mp3"], text:"Du hast nun die fertige L√∂sung in der Perfusorspritze. Diese musst du noch kennzeichnen. Nimm daf√ºr die vorgefertigten Aufkleber und achte unbedingt auf die richtige Kennzeichnung. Du hast 20 Mikrogramm Noradrenalin pro Milliliter in der Perfusorspritze. Klebe die Kennzeichnung so, dass die Milliliterangaben der Spritze erkennbar bleiben. Wenn du fertig bist, sag ‚Äûweiter‚Äú." },
      { phrases:["weiter"], audios:["11.mp3"], text:"Nachdem du die Medikamentenl√∂sung im Vieraugenprinzip gegengecheckt hast, kannst du die Spritze in den Perfusor einlegen. Wenn du m√∂chtest, erkl√§re ich dir noch, wie man den Perfusor mit der entsprechenden Laufrate einstellt ‚Äì sag dazu einfach ‚ÄûPerfusor‚Äú. Hast du noch weitere Fragen?" },
      { phrases:["nein","danke"], audios:["12.mp3"], text:"Ok, gern gesehen." }
    ];

    const chat=document.getElementById("chat");
    const bar=document.getElementById("bar");
    const logo=document.getElementById("logo");
    const player=document.getElementById("player");
    const readyPing=document.getElementById("ready");
    const repeatSfx=document.getElementById("repeat");
    const controls=document.getElementById("controls");

    let recognition=null, listening=false, swLocked=false;
    let idx=0, queue=[];
    const total=steps.length;
    let precision=false; // Pr√§zisionsmodus f√ºr Sprachsteuerung

    /* ======= Utilities ======= */
    function normalize(s=""){
      return s.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9√§√∂√º√ü\s]/g," ")
        .replace(/\s+/g," ").trim();
    }
    function prettify(raw){
      let t=" "+normalize(raw)+" ";
      t=t.replace(/\bnor adrenalin(e)?\b/g," noradrenalin ").replace(/\bnur adrenalin(e)?\b/g," noradrenalin ")
       .replace(/\bnora adrenalin(e)?\b/g," noradrenalin ").replace(/\bnora\b/g," noradrenalin ").replace(/\bnoradrenaline?\b/g," noradrenalin ");
      t=t.replace(/\bperfusor\b/g," Perfusor ").replace(/\b20 mikrogramm\b/g," 20 Mikrogramm ").replace(/\b50 ml\b/g," 50 ml ");
      t=t.replace(/\bweiter\b/g," weiter ").replace(/\bja\b/g," ja ").replace(/\bnein\b/g," nein ");
      t=t.replace(/\s+/g," ").trim(); if(t.length) t=t[0].toUpperCase()+t.slice(1); return t || raw;
    }
    function addMsg(text, who){ const d=document.createElement("div"); d.className="msg "+who; d.textContent=text; chat.appendChild(d); chat.scrollTop=chat.scrollHeight; }
    function updateProgress(){ bar.style.width=Math.round((idx/total)*100)+"%"; }
    function lev(a,b){ const m=a.length,n=b.length,dp=new Array(n+1); for(let j=0;j<=n;j++) dp[j]=j; for(let i=1;i<=m;i++){ let prev=dp[0]; dp[0]=i; for(let j=1;j<=n;j++){ const tmp=dp[j]; dp[j]=Math.min(dp[j]+1, dp[j-1]+1, prev+(a[i-1]===b[j-1]?0:1)); prev=tmp; } } return dp[n]; }
    function fuzzyIncludes(text, phrase){
      if(text.includes(phrase)) return true;
      const words=text.split(" ");
      for(const w of words){ if(lev(w,phrase)<=2) return true; }
      if(phrase.includes(" ")){ const parts=phrase.split(" "); return parts.every(p=>words.some(w=>w===p || lev(w,p)<=1)); }
      return false;
    }
    function isRepeat(t){
      return ( t.includes("nochmal") || t.includes("noch mal") || t.includes("noch einmal") ||
               t.includes("nochma")  || t.includes("wiederholen") || t.includes("repeat") ||
               (t.includes("noch") && t.includes("mal")) );
    }

    /* ======= Audio-Flow (mit snappy Ready-Ping) ======= */
    function stopAllAudio(){ try{ player.pause(); }catch{} player.currentTime=0; queue=[]; }
    function playReadyNow(){
      try {
        readyPing.pause(); readyPing.currentTime=0;
        readyPing.playbackRate=1.15; readyPing.preservesPitch=true;
        readyPing.play().catch(()=>{});
      } catch(e) {}
    }
    function playStepAt(index, {advance=true} = {}){
      const step = steps[index];
      addMsg(step.text, "pallas");
      queue=[...step.audios];
      swLocked=true; stopListeningSilently();
      playNext(() => {
        playReadyNow();
        swLocked=false;
        setTimeout(()=>{ if(listening) startListening(); }, 30);
        if (advance && index===idx) idx++;
        updateProgress();
      });
    }
    function playNext(done){
      if(queue.length===0){ done && done(); return; }
      const f = queue.shift();
      player.src=f;
      player.preload="auto";
      let readyTriggered=false;
      player.ontimeupdate=()=>{ // Preroll ~80ms vor Ende
        if(readyTriggered) return;
        if(queue.length===0 && player.duration && (player.duration - player.currentTime) <= 0.08){
          readyTriggered=true; playReadyNow();
        }
      };
      player.onended=()=>{ if(queue.length>0) playNext(done); else done&&done(); };
      player.onerror=()=>{ if(queue.length>0) playNext(done); else done&&done(); };
      player.play().catch(()=>{ if(queue.length>0) playNext(done); else done&&done(); });
    }

    /* ======= Command Handling (f√ºr Speech & Text) ======= */
    function handleCommand(inputText){
      const text = normalize(inputText);
      if(idx>=steps.length) return;

      // Wiederholen
      if(isRepeat(text)){
        addMsg("Ok, nochmal.", "pallas");
        repeatSfx.play().catch(()=>{});
        if (swLocked) { stopAllAudio(); playStepAt(idx, {advance:false}); }
        else { const prev=Math.max(0, idx-1); playStepAt(prev, {advance:false}); }
        return;
      }

      // Pr√§zisionsmodus: nur f√ºr Sprachsteuerung relevant; Text-Eingabe ignoriert das
      const speechMode = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
      if(speechMode && precision && idx>0 && !text.includes("pallas")) return;

      // Normaler Ablauf
      const step = steps[idx];
      let matched=false;
      for(const phr of step.phrases){ if(fuzzyIncludes(text, phr)){ matched=true; break; } }

      // Extra tolerant bei Schritt 2 (Noradrenalin/Perfusor)
      if(!matched && idx===1){
        const hasNor = ["noradrenalin","nor adrenalin","nur adrenalin","nora adrenalin","nora","noradrenaline"].some(p=>fuzzyIncludes(text,p));
        const hasPerf = fuzzyIncludes(text,"perfusor");
        matched = hasNor || hasPerf;
      }

      if(matched) playStepAt(idx, {advance:true});
    }

    /* ======= Speech Recognition (nur wenn verf√ºgbar) ======= */
    function createRecognizer(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR) return null;
      const r=new SR();
      r.lang="de-DE"; r.continuous=true; r.interimResults=false;
      r.onresult=(ev)=>{
        if(swLocked) return;
        for(let i=ev.resultIndex;i<ev.results.length;i++){
          const res=ev.results[i]; if(!res.isFinal) continue;
          const raw=res[0].transcript||"";
          addMsg(prettify(raw), "user");
          handleCommand(raw);
        }
      };
      r.onend=()=>{ if(listening && !swLocked){ try{ r.start(); }catch{} } };
      return r;
    }
    function startListening(){
      if(!recognition) recognition=createRecognizer();
      if(!recognition){ addMsg("‚ùå Sprachsteuerung nicht verf√ºgbar.","pallas"); return; }
      try{ recognition.start(); }catch{}
      listening=true; document.getElementById("micDot")?.classList.replace("red","green");
      document.getElementById("micDot")?.setAttribute("title","Mikro an");
      logo.classList.add("listening");
    }
    function stopListeningSilently(){ try{ recognition && recognition.stop(); }catch{} }
    function stopListening(){
      listening=false; stopListeningSilently();
      document.getElementById("micDot")?.classList.replace("green","red");
      document.getElementById("micDot")?.setAttribute("title","Mikro aus");
      logo.classList.remove("listening");
    }

    /* ======= Diagnose ======= */
    function diagnose(){
      if (location.protocol!=="https:") {
        addMsg("‚ö†Ô∏è Hinweis: Sprachsteuerung ben√∂tigt HTTPS. Aktuell l√§uft die App √ºber '"+location.protocol+"'.", "pallas");
      }
      if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
        addMsg("‚ö†Ô∏è Dein Browser unterst√ºtzt keine Sprachsteuerung. Nutze Chrome/Edge ‚Äì oder verwende das Eingabefeld unten.", "pallas");
      }
    }

    /* ======= UI dynamisch aufbauen (Speech vs. Text) ======= */
    function buildControls(){
      const hasSpeech = ('SpeechRecognition' in window) || ('webkitSpeechRecognition' in window);
      if (hasSpeech){
        controls.innerHTML = `
          <div class="left">
            <button id="micToggle" class="iconbtn" aria-label="Mikrofon umschalten" title="Mikrofon umschalten">üé§</button>
            <span id="micDot" class="dot red" title="Mikro aus"></span>
            <button id="reset" class="iconbtn" aria-label="Reset" title="Zur√ºcksetzen">üîÑ</button>
          </div>
          <div class="right">
            <div class="toggle" title="Wenn an: Befehle mit ‚ÄöPallas ‚Ä¶‚Äò (z. B. ‚ÄöPallas weiter‚Äò).">
              <div id="precSwitch" class="switch"></div>
              <span>Pr√§zisionsmodus</span>
            </div>
          </div>`;
        const micBtn=document.getElementById("micToggle");
        const resetBtn=document.getElementById("reset");
        const precSwitch=document.getElementById("precSwitch");
        micBtn.addEventListener("click", ()=>{ if(listening){ stopListening(); } else { recognition=null; startListening(); } });
        resetBtn.addEventListener("click", ()=>{ idx=0; queue=[]; stopListening(); chat.innerHTML=""; updateProgress(); addMsg("Sag 'Hey PALLAS' um zu starten.","pallas"); });
        precSwitch.addEventListener("click", ()=>{ precision=!precision; precSwitch.classList.toggle("on", precision); });
        // Ready-Ping vorw√§rmen beim ersten Klick
        micBtn.addEventListener("click", ()=>{ try{ readyPing.load(); if(readyPing.currentTime===0){ readyPing.play().then(()=>readyPing.pause()).catch(()=>{}); } }catch(e){} });
      } else {
        controls.innerHTML = `
          <div class="left" style="flex:1; gap:8px;">
            <input id="textInput" class="textinput" placeholder="Befehl eingeben ‚Ä¶ (z. B. 'weiter', 'nochmal', 'Pallas ‚Ä¶')" />
            <button id="sendBtn" class="iconbtn" aria-label="Senden" title="Senden">‚û°Ô∏è</button>
            <button id="reset" class="iconbtn" aria-label="Reset" title="Zur√ºcksetzen">üîÑ</button>
          </div>`;
        const sendBtn=document.getElementById("sendBtn");
        const resetBtn=document.getElementById("reset");
        const input=document.getElementById("textInput");
        sendBtn.addEventListener("click", ()=>{
          const val=input.value.trim();
          if(!val) return;
          addMsg(prettify(val),"user");
          handleCommand(val);
          input.value="";
          input.focus();
        });
        input.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ sendBtn.click(); } });
        resetBtn.addEventListener("click", ()=>{ idx=0; queue=[]; chat.innerHTML=""; updateProgress(); addMsg("Tippe 'Hey PALLAS' um zu starten.","pallas"); });
      }
    }

    /* ======= Init ======= */
    updateProgress();
    addMsg("Sag 'Hey PALLAS' um zu starten.","pallas");
    buildControls();
    diagnose();
  </script>
</body>
</html>
