<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>PALLAS Sprachdemo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root { --pallas:#2a5d84; --bg:#eef3f8; --bubble-user:#daf0ff; --bubble-pallas:#ffffff; --ok:#2ecc71; --err:#e74c3c; }
    body { margin:0; font-family:'Segoe UI', Roboto, Arial, sans-serif; background:var(--bg); display:flex; flex-direction:column; height:100vh; }
    header { background:var(--pallas); color:#fff; padding:14px 20px; display:flex; align-items:center; gap:12px; box-shadow:0 2px 6px rgba(0,0,0,.15); }
    header h1 { margin:0; font-size:20px; font-weight:700; }
    #logo { width:48px; height:48px; border-radius:50%; background:var(--pallas); display:grid; place-items:center; color:#fff; position:relative; }
    #logo.listening::after { content:""; position:absolute; inset:0; border-radius:50%; border:2px solid rgba(42,93,132,.4); animation:pulse 1.6s infinite; }
    @keyframes pulse { 0%{transform:scale(1); opacity:.6;} 70%{transform:scale(1.4); opacity:0;} 100%{opacity:0;} }
    .progress { height:6px; background:#cbd5e1; width:100%; }
    .bar { height:100%; background:linear-gradient(90deg,#2a5d84,#3b7aa9); width:0%; transition:width .4s ease; }
    main { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:12px; }
    .msg { max-width:70%; padding:12px 16px; border-radius:18px; font-size:16px; line-height:1.4; animation:fadeIn .3s ease; word-break:break-word; }
    .msg.user { background:var(--bubble-user); align-self:flex-end; border-bottom-right-radius:4px; }
    .msg.pallas { background:var(--bubble-pallas); align-self:flex-start; border-bottom-left-radius:4px; box-shadow:0 2px 4px rgba(0,0,0,.08); }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:none;} }
    footer { padding:12px; background:#fff; display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center; border-top:1px solid #e2e8f0; position:sticky; bottom:0; }
    footer .left, footer .right { display:flex; gap:12px; align-items:center; }

    /* Icon-Button */
    .iconbtn { display:inline-grid; place-items:center; width:44px; height:44px; border:none; border-radius:10px; background:var(--pallas); color:#fff; font-size:20px; cursor:pointer; }
    .iconbtn:hover { filter:brightness(.95); }
    .dot { width:12px; height:12px; border-radius:50%; box-shadow:0 0 0 2px #ffffff; }
    .dot.green { background:var(--ok); }
    .dot.red   { background:var(--err); }

    /* Pr√§zisionsmodus Toggle */
    .toggle { display:flex; align-items:center; gap:8px; font-size:14px; color:#173249; }
    .switch { position:relative; width:44px; height:24px; background:#cbd5e1; border-radius:999px; cursor:pointer; }
    .switch::after { content:""; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background:#fff; transition:left .2s ease; }
    .switch.on { background:#2a5d84; }
    .switch.on::after { left:23px; }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <script>
    if ("serviceWorker" in navigator) { navigator.serviceWorker.register("service-worker.js").catch(()=>{}); }
  </script>
</head>
<body>
  <header>
    <div id="logo">üé§</div>
    <h1>PALLAS ‚Äì Pflegeassistenz</h1>
  </header>

  <div class="progress"><div id="bar" class="bar"></div></div>

  <main id="chat"></main>

  <footer>
    <div class="left">
      <!-- Icon-Button + Statuspunkt -->
      <button id="micToggle" class="iconbtn" aria-label="Mikrofon umschalten" title="Mikrofon umschalten">üé§</button>
      <span id="micDot" class="dot red" title="Mikro aus"></span>

      <button id="reset" class="iconbtn" aria-label="Reset" title="Zur√ºcksetzen">üîÑ</button>
    </div>
    <div class="right">
      <div class="toggle" title="Wenn an, dann nur Befehle mit Pr√§fix ‚ÄöPallas ‚Ä¶‚Äò (z. B. ‚ÄöPallas weiter‚Äò).">
        <div id="precSwitch" class="switch"></div>
        <span>Pr√§zisionsmodus</span>
      </div>
    </div>
  </footer>

  <!-- Audio -->
  <audio id="player" controls style="display:none"></audio>
  <audio id="ready"  preload="auto" src="1.mp3"></audio>
  <audio id="repeat" preload="auto" src="nochmal.mp3"></audio>

  <script>
    /* ---------- Schritte ---------- */
    const steps = [
      { phrases:["hey","pallas","hallo"], audios:["1.mp3","2.mp3"], text:"Hallo, was kann ich f√ºr dich tun?" },
      { phrases:["noradrenalin","nor adrenalin","nur adrenalin","nora","noradrenaline","nora adrenalin","perfusor"], audios:["3.mp3"], text:"Alles klar, einen Noradrenalin Perfusor also. Welche Dosierung m√∂chtest du vorbereiten?" },
      { phrases:["50","20 mikrogramm"], audios:["4.mp3"], text:"In Ordnung. Du m√∂chtest also eine 50ml Noradrenalinperfursor Spritze mit einer Dosierung von 20 Mikrogramm pro Milliliter vorbereiten, habe ich das richtig verstanden?" },
      { phrases:["ja","genau","richtig"], audios:["5.mp3"], text:"Ok du ben√∂tigst daf√ºr folgende Materialien: Ein Medikamententablett, Alkoholisches Desinfektionsmittel, Aufziehkan√ºle, Perfusorspritze, Brechampulle Noradrenalin 1mg auf 1 Milliliter, 50 ml NaCl, Perfusioleitung, Einmalhandschuhe und Abwurfbeh√§lter. Wenn dir das zu schnell ging, sag einfach ‚ÄûNochmal‚Äú, wenn du so weit bist sag einfach ‚ÄûWeiter‚Äú." },
      { phrases:["weiter"], audios:["6.mp3"], text:"Nachdem du dir die Einmal-Handschuhe angezogen hast, bereitest du nun die Perfusor Spritze vor. √ñffne die Spritze an der daf√ºr vorgesehenen Lasche. Beachte, dass der Konus der Spritze weiterhin in der sterilen Verpackung bleibt. Nimm dir nun das vorbereitete NaCl und desinfiziere die Einstichstelle mit der Desinfektionsl√∂sung. Achte auf die vorgeschriebene Einwirkzeit. Wenn du so weit bist, sag einfach ‚Äûweiter‚Äú." },
      { phrases:["weiter"], audios:["7.mp3"], text:"Ziehe dir nun 49ml NaCl mit der Perfusorspritze und der dazugeh√∂rigen Aufziehkan√ºle auf. Verwurfe danach die Aufziehkan√ºle im Abwurfbeh√§lter. Achte besonders darauf, den Konus der Perfusorspritze nicht zu verunreinigen. √ñffne nun die Verpackung der anderen Aufziehkan√ºle und verbinde diese mit der Perfusorspritze. Wenn du so weit bist, sag einfach ‚Äûweiter‚Äú." },
      { phrases:["weiter"], audios:["8.mp3"], text:"Belasse die Perfusorspritze mit der konnektierten Aufziehkan√ºle in der Verpackung. Nimm jetzt die Noradrenalin-Brechampulle, pr√ºfe noch einmal, ob es sich um das richtige Medikament und die richtige Dosierung handelt. Halte die Sollbruchstelle zu dir hin und brich die Ampulle auf. Achte sorgf√§ltig darauf, die ge√∂ffnete Ampulle nicht zu verunreinigen. Ziehe nun das Medikament mit der Perfusorspritze auf." },
      { phrases:["weiter"], audios:["9.mp3"], text:"Verwirf die Aufziehkan√ºle in den Abwurfbeh√§lter. √ñffne die Verpackung der Perfusor-Leitung, nimm den Abgang der Leitung und verbinde ihn mit der Perfusorspritze. Bef√ºlle die gesamte Leitung mit der Medikamentenl√∂sung, bis sich keine Luft mehr in Spritze und Leitungssystem befindet. Die patientennahe Kappe bleibt vorerst an der Leitung. Wenn du fertig bist, sag ‚Äûweiter‚Äú." },
      { phrases:["weiter"], audios:["10.mp3"], text:"Du hast nun die fertige L√∂sung in der Perfusorspritze. Diese musst du noch kennzeichnen. Nimm daf√ºr die vorgefertigten Aufkleber und achte unbedingt auf die richtige Kennzeichnung. Du hast 20 Mikrogramm Noradrenalin pro Milliliter in der Perfusorspritze. Klebe die Kennzeichnung so, dass die Milliliterangaben der Spritze erkennbar bleiben. Wenn du fertig bist, sag ‚Äûweiter‚Äú." },
      { phrases:["weiter"], audios:["11.mp3"], text:"Nachdem du die Medikamentenl√∂sung im Vieraugenprinzip gegengecheckt hast, kannst du die Spritze in den Perfusor einlegen. Wenn du m√∂chtest, erkl√§re ich dir noch, wie man den Perfusor mit der entsprechenden Laufrate einstellt ‚Äì sag dazu einfach ‚ÄûPerfusor‚Äú. Hast du noch weitere Fragen?" },
      { phrases:["nein","danke"], audios:["12.mp3"], text:"Ok, gern gesehen." }
    ];

    /* ---------- State & UI ---------- */
    let idx=0, queue=[];
    let recognition=null, listening=false, swLocked=false;
    const total=steps.length;

    const chat=document.getElementById("chat");
    const player=document.getElementById("player");
    const readyPing=document.getElementById("ready");
    const repeatSfx=document.getElementById("repeat");

    const bar=document.getElementById("bar");
    const logo=document.getElementById("logo");
    const micBtn=document.getElementById("micToggle");
    const micDot=document.getElementById("micDot");
    const resetBtn=document.getElementById("reset");
    const precSwitch=document.getElementById("precSwitch");
    let precision=false; // Pr√§zisionsmodus aus

    /* ---------- Utils ---------- */
    function normalize(s=""){
      return s.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9√§√∂√º√ü\s]/g," ")
        .replace(/\s+/g," ").trim();
    }
    function prettify(raw){
      let t=" "+normalize(raw)+" ";
      t=t.replace(/\bnor adrenalin(e)?\b/g," noradrenalin ").replace(/\bnur adrenalin(e)?\b/g," noradrenalin ")
       .replace(/\bnora adrenalin(e)?\b/g," noradrenalin ").replace(/\bnora\b/g," noradrenalin ").replace(/\bnoradrenaline?\b/g," noradrenalin ");
      t=t.replace(/\bperfusor\b/g," Perfusor ").replace(/\b20 mikrogramm\b/g," 20 Mikrogramm ").replace(/\b50 ml\b/g," 50 ml ");
      t=t.replace(/\bweiter\b/g," weiter ").replace(/\bja\b/g," ja ").replace(/\bnein\b/g," nein ");
      t=t.replace(/\s+/g," ").trim(); if(t.length) t=t[0].toUpperCase()+t.slice(1); return t || raw;
    }
    function lev(a,b){ const m=a.length,n=b.length,dp=new Array(n+1); for(let j=0;j<=n;j++) dp[j]=j; for(let i=1;i<=m;i++){ let prev=dp[0]; dp[0]=i; for(let j=1;j<=n;j++){ const tmp=dp[j]; dp[j]=Math.min(dp[j]+1, dp[j-1]+1, prev+(a[i-1]===b[j-1]?0:1)); prev=tmp; } } return dp[n]; }
    function fuzzyIncludes(text, phrase){
      if(text.includes(phrase)) return true;
      const words=text.split(" ");
      for(const w of words){ if(lev(w,phrase)<=2) return true; }
      if(phrase.includes(" ")){ const parts=phrase.split(" "); return parts.every(p=>words.some(w=>w===p || lev(w,p)<=1)); }
      return false;
    }
    function addMsg(text, who){ const d=document.createElement("div"); d.className="msg "+who; d.textContent=text; chat.appendChild(d); chat.scrollTop=chat.scrollHeight; }
    function updateProgress(){ bar.style.width=Math.round((idx/total)*100)+"%"; }

    /* ---------- Audio helpers ---------- */
    function stopAllAudio(){
      try{ player.pause(); }catch{}
      player.currentTime = 0;
      queue = [];
    }

    // zentrales Abspielen: beliebigen Schritt starten; advance=true => Fortschritt erh√∂hen
    function playStepAt(index, {advance=true} = {}){
      const step = steps[index];
      addMsg(step.text, "pallas");

      queue = [...step.audios];
      swLocked = true;
      stopListeningSilently();

      // READY-PING sofort & knackig nach Abschluss
      const afterAll = async () => {
        try {
          readyPing.pause();
          readyPing.currentTime = 0;
          readyPing.playbackRate = 1.15;  // etwas schneller = ‚Äûsnappier‚Äú
          await readyPing.play();
        } catch(e) {}
        swLocked = false;
        // Mikro sehr kurz sp√§ter wieder aktivieren
        setTimeout(()=>{ if(listening) startListening(); }, 60);
        if (advance) { if (index === idx) idx++; }
        updateProgress();
      };

      playNext(afterAll);
    }

    function playNext(done){
      if(queue.length===0){ done && done(); return; }
      const f = queue.shift();
      player.src = f;
      player.onended = () => playNext(done);
      player.onerror = () => playNext(done);
      // wichtig: sofort starten, Fehler abfangen
      player.play().catch(()=>playNext(done));
    }

    /* ---------- Speech ---------- */
    function createRecognizer(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR) return null;
      const r=new SR();
      r.lang="de-DE"; r.continuous=true; r.interimResults=false;
      r.onresult=(ev)=>{
        if(swLocked) return;
        for(let i=ev.resultIndex;i<ev.results.length;i++){
          const res=ev.results[i]; if(!res.isFinal) continue;
          const raw=res[0].transcript||""; const norm=normalize(raw);
          addMsg(prettify(raw), "user");
          handleCommand(norm);
        }
      };
      r.onend=()=>{ if(listening && !swLocked){ try{ r.start(); }catch{} } };
      return r;
    }
    function startListening(){
      if(!recognition) recognition=createRecognizer();
      if(!recognition){ micBtn.title="Nicht unterst√ºtzt"; return; }
      try{ recognition.start(); }catch{}
      listening=true; logo.classList.add("listening");
      micDot.classList.remove("red"); micDot.classList.add("green"); micDot.title="Mikro an";
    }
    function stopListeningSilently(){ try{ recognition && recognition.stop(); }catch{} }
    function stopListening(){
      listening=false; stopListeningSilently(); logo.classList.remove("listening");
      micDot.classList.remove("green"); micDot.classList.add("red"); micDot.title="Mikro aus";
    }

    /* ---------- Command Handling ---------- */
    function isRepeat(t){
      return ( t.includes("nochmal") || t.includes("noch mal") || t.includes("noch einmal") ||
               t.includes("nochma")  || t.includes("wiederholen") || t.includes("repeat") ||
               (t.includes("noch") && t.includes("mal")) );
    }

    let precision=false;
    function handleCommand(text){
      if(idx>=total) return;

      // Pr√§zisionsmodus: ab Schritt 1 nur reagieren, wenn "pallas" gesagt wird
      if(precision && idx>0 && !text.includes("pallas")) return;

      // --- Wiederholen ---
      if(isRepeat(text)){
        addMsg("Ok, nochmal.", "pallas");
        repeatSfx.play().catch(()=>{});
        if (swLocked) {
          stopAllAudio();
          playStepAt(idx, {advance:false});
        } else {
          const prev = Math.max(0, idx - 1);
          playStepAt(prev, {advance:false});
        }
        return;
      }

      // --- Normaler Ablauf ---
      const step=steps[idx];
      let matched=false;
      for(const phr of step.phrases){ if(fuzzyIncludes(text, phr)){ matched=true; break; } }
      if(!matched && idx===1){
        const hasNor = ["noradrenalin","nor adrenalin","nur adrenalin","nora adrenalin","nora","noradrenaline"].some(p=>fuzzyIncludes(text,p));
        const hasPerf = fuzzyIncludes(text,"perfusor");
        matched = hasNor || hasPerf;
      }
      if(matched) playStepAt(idx, {advance:true});
    }

    /* ---------- Controls ---------- */
    micBtn.addEventListener("click", ()=>{ if(listening){ stopListening(); } else { recognition=null; startListening(); } });
    resetBtn.addEventListener("click", ()=>{ idx=0; queue=[]; stopListening(); chat.innerHTML=""; updateProgress(); addMsg("Sag 'Hey PALLAS' um zu starten.","pallas"); });
    precSwitch.addEventListener("click", ()=>{ precision=!precision; precSwitch.classList.toggle("on", precision); });

    /* ---------- Init ---------- */
    updateProgress();
    addMsg("Sag 'Hey PALLAS' um zu starten.", "pallas");
    // Ready-Ping vorw√§rmen (schneller Start)
    readyPing.load();
  </script>
</body>
</html>
